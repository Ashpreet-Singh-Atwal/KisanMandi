<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard - KisanMandi</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary-green:#2d5016;
      --secondary-green:#3f6b2a;
      --accent:#3498db;
      --gold:#f4a261;
      --success:#27ae60;
      --muted:#95a5a6;
      --bg:#f6fbf6;
      --card:#ffffff;
      --glass: rgba(255,255,255,0.85);
      --shadow: 0 8px 30px rgba(18,40,18,0.06);
      --radius: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg) 0%, #f0f7f0 100%);
      color:#1f2d1f;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
    }

    /* LAYOUT */
    .sidebar{
      position:fixed;
      left:0;top:0;bottom:0;
      width:250px;
      background: linear-gradient(180deg, var(--primary-green), var(--secondary-green));
      color:#fff;
      padding:1.25rem 1rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      box-shadow: 4px 0 30px rgba(0,0,0,0.08);
      z-index:1000;
    }
    .sidebar .brand{
      display:flex;align-items:center;gap:.6rem;margin-bottom:.25rem;
    }
    .sidebar .brand i{font-size:1.35rem;color:var(--gold)}
    .sidebar .brand .title{font-weight:700;font-size:1.15rem;letter-spacing:.2px}
    .user-info{display:flex;align-items:center;gap:.75rem;padding:.4rem 0}
    .avatar{
      width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:1.25rem;
      box-shadow:inset 0 -2px 6px rgba(0,0,0,0.06);
    }
    .user-meta{line-height:1}
    .user-meta .name{font-weight:600}
    .user-meta .role{font-size:.85rem;opacity:.9}

    .nav{margin-top:10px;display:flex;flex-direction:column;gap:.35rem}
    .nav a{display:flex;align-items:center;gap:.8rem;color:rgba(255,255,255,0.95);text-decoration:none;padding:.65rem .7rem;border-radius:10px;transition:all .18s}
    .nav a:hover{background:rgba(255,255,255,0.06)}
    .nav a.active{background:rgba(255,255,255,0.07);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}

    .main{
      margin-left:250px;
      padding:1.35rem 2rem;
      min-height:100vh;
      transition:margin-left .2s;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:1rem;background:var(--card);padding:.9rem 1rem;border-radius:12px;box-shadow:var(--shadow);margin-bottom:1.25rem;
    }
    .page-title{display:flex;flex-direction:column;gap:.15rem}
    .page-title h1{margin:0;font-size:1.25rem;color:var(--primary-green)}
    .page-title .crumb{font-size:.85rem;color:var(--muted)}

    .top-actions{display:flex;align-items:center;gap:.7rem}
    .search-wrap{position:relative}
    .search{padding:.55rem .9rem;border-radius:999px;border:1px solid #eef5ee;background:transparent;min-width:260px}
    .search:focus{outline:none;box-shadow:0 6px 18px rgba(18,40,18,0.04)}
    .icon-right{position:absolute;right:.6rem;top:50%;transform:translateY(-50%);color:var(--muted)}

    .notif{position:relative;background:var(--card);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border:1px solid #eef5ee}
    .badge{
      position:absolute;right:-6px;top:-6px;background:var(--gold);color:#0b2a0b;font-weight:700;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:.75rem;border:2px solid var(--card)
    }

    /* GRID */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(5, minmax(160px,1fr));
      gap:1rem;
      margin-bottom:1.25rem;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:1rem 1rem;
      box-shadow:var(--shadow);
      min-height:98px;
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .card .k{font-size:1rem;color:var(--muted)}
    .card .v{font-size:1.5rem;font-weight:700;color:var(--primary-green);margin-top:.25rem}

    /* Quick Links */
    .links-row{display:flex;gap:1rem;align-items:center;margin: .5rem 0 1.2rem 0;flex-wrap:wrap}
    .link{background:transparent;color:var(--accent);text-decoration:underline;font-weight:600}

    /* DASHBOARD GRID */
    .dashboard-grid{display:grid;grid-template-columns:2fr 1fr;gap:1rem;align-items:start}
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .panel .panel-head{padding:1rem 1.1rem;border-bottom:1px solid #f1f6f1;display:flex;justify-content:space-between;align-items:center}
    .panel .panel-body{padding:1rem 1.1rem}

    /* Pills */
    .pills{display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:.9rem}
    .pill{padding:.45rem .8rem;border-radius:999px;background:#f3faf3;border:1px solid #eef6ee;color:var(--primary-green);font-weight:600;cursor:pointer;transition:all .15s}
    .pill.active{background:var(--primary-green);color:white;box-shadow:0 6px 18px rgba(18,40,18,0.06)}

    /* crop list */
    .crop-list{display:grid;gap:.9rem}
    .crop-row{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.9rem;border-radius:10px;border:1px solid #f1f5f1}
    .crop-left{display:flex;gap:1rem;align-items:center}
    .crop-thumb{width:66px;height:66px;border-radius:10px;background:#fbfff9;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
    .crop-meta .title{font-weight:700}
    .crop-meta .sub{font-size:.88rem;color:var(--muted)}

    .crop-right{text-align:right;min-width:160px}
    .price{font-weight:800;color:var(--success)}
    .qty{color:var(--muted);font-size:.9rem;margin-top:.28rem}

    .actions{display:flex;gap:.45rem;justify-content:flex-end;margin-top:.5rem}
    .btn{padding:.45rem .7rem;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:#f2fafc;color:var(--primary-green);border:1px solid #eef9fc}

    /* right column */
    .right-col{display:flex;flex-direction:column;gap:1rem}
    .order-item{display:flex;gap:.75rem;align-items:center;padding:.6rem;border-radius:8px;border:1px solid #f1f6f1}
    .order-item .left{width:44px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center}
    .order-meta .title{font-weight:700}
    .order-meta .sub{color:var(--muted);font-size:.9rem}
    .trend-item{display:flex;align-items:center;justify-content:space-between;padding:.55rem;border-radius:8px;border:1px solid #f1f6f1;margin-bottom:.5rem}

    /* responsive */
    @media (max-width:1100px){
      .stats-grid{grid-template-columns:repeat(3,1fr)}
      .dashboard-grid{grid-template-columns:1fr; row-gap:1rem}
      .main{padding:1rem}
    }
    @media (max-width:760px){
      .sidebar{display:none}
      .main{margin-left:0;padding:1rem}
      .search{min-width:140px}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-seedling"></i>
      <div class="title">KisanMandi</div>
    </div>

    <div class="user-info">
      <div class="avatar"><i class="fas fa-store"></i></div>
      <div class="user-meta">
        <div class="name"><%= (typeof buyer !== 'undefined' && buyer && buyer.name) ? buyer.name : 'Buyer' %></div>
        <div class="role">Buyer</div>
      </div>
    </div>

    <nav class="nav">
      <a href="/buyer/dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="/buyer/browse"><i class="fas fa-search"></i> Browse Crops</a>
      <a href="/buyer/orders"><i class="fas fa-shopping-cart"></i> My Orders</a>
      <a href="/buyer/favorites"><i class="fas fa-heart"></i> Favorites</a>
      <a href="/buyer/transactions"><i class="fas fa-credit-card"></i> Transactions</a>
      <a href="/buyer/farmers"><i class="fas fa-users"></i> Farmers</a>
      <a href="/buyer/market-prices"><i class="fas fa-chart-line"></i> Market Prices</a>
      <a href="/buyer/profile"><i class="fas fa-user-cog"></i> Profile</a>
      <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="page-title">
        <h1>Buyer Dashboard</h1>
        <div class="crumb">Home / Dashboard</div>
      </div>

      <div class="top-actions">
        <div class="search-wrap">
          <input class="search" placeholder="Search crops, farmers..." />
          <i class="fas fa-search icon-right"></i>
        </div>

        <div class="notif" title="Notifications">
          <i class="fas fa-bell"></i>
          <span class="badge"><%= (typeof stats !== 'undefined' && stats && stats.unreadNotifications) ? stats.unreadNotifications : 0 %></span>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <section class="stats-grid" aria-label="Stats">
      <div class="card">
        <div class="k"><i class="fas fa-shopping-cart" style="color:var(--muted)"></i> Total Orders</div>
        <div class="v"><%= (typeof totalOrders !== 'undefined') ? totalOrders : 0 %></div>
        <div class="k" style="font-size:.82rem;color:var(--muted)">dynamic</div>
      </div>

      <div class="card">
        <div class="k">â‚¹ Total Spent</div>
        <div class="v">â‚¹<%= (typeof totalSpent !== 'undefined') ? Number(totalSpent).toLocaleString('en-IN') : '0' %></div>
        <div class="k" style="font-size:.82rem;color:var(--muted)">all time</div>
      </div>

      <div class="card">
        <div class="k"><i class="fas fa-truck" style="color:var(--muted)"></i> Active Shipments</div>
        <div class="v"><%= (typeof activeShipments !== 'undefined') ? activeShipments : 0 %></div>
        <div class="k" style="font-size:.82rem;color:var(--muted)">in transit</div>
      </div>

      <div class="card">
        <div class="k"><i class="fas fa-users" style="color:var(--muted)"></i> Trusted Farmers</div>
        <div class="v"><%= (typeof trustedFarmers !== 'undefined') ? trustedFarmers : 0 %></div>
        <div class="k" style="font-size:.82rem;color:var(--muted)">verified</div>
      </div>

      <div class="card">
        <div class="k"><i class="fas fa-heart" style="color:var(--muted)"></i> Favorite Crops</div>
        <div class="v"><%= (typeof favorites !== 'undefined') ? favorites : 0 %></div>
        <div class="k" style="font-size:.82rem;color:var(--muted)">saved</div>
      </div>
    </section>

    <div class="links-row">
      <a class="link" href="/buyer/browse"><i class="fas fa-search"></i> Browse Crops</a>
      <a class="link" href="/buyer/orders"><i class="fas fa-list"></i> Track Orders</a>
      <a class="link" href="/buyer/favorites"><i class="fas fa-heart"></i> My Favorites</a>
      <a class="link" href="/buyer/profile"><i class="fas fa-user-edit"></i> Update Profile</a>
    </div>

    <!-- Main panels -->
    <div class="dashboard-grid">
      <!-- left: crops -->
      <section class="panel">
        <div class="panel-head">
          <div style="display:flex;align-items:center;gap:.6rem">
            <i class="fas fa-seedling" style="color:var(--primary-green)"></i>
            <div style="font-weight:700">Fresh Crops Available</div>
          </div>
          <a href="/buyer/browse" style="color:var(--accent);font-weight:700;text-decoration:none">View All</a>
        </div>

        <div class="panel-body">
          <div class="pills" role="list">
            <div class="pill active">All</div>
            <div class="pill">Vegetables</div>
            <div class="pill">Grains</div>
            <div class="pill">Fruits</div>
            <div class="pill">Organic</div>
          </div>

          <div class="crop-list">
            <% if (typeof crops === 'undefined' || !crops || crops.length === 0) { %>
              <div style="padding:1.1rem;color:var(--muted)">No crops available right now. Check later or ask farmers to list crops.</div>
            <% } else { %>
              <% crops.forEach(function(c){ %>
                <div class="crop-row">
                  <div class="crop-left">
                    <div class="crop-thumb">ðŸŒ¾</div>
                    <div class="crop-meta">
                      <div class="title"><%= c.name || 'Unknown' %></div>
                      <div class="sub">
                        <%= (c.farmer && c.farmer.name) ? c.farmer.name : 'Farmer' %> â€¢ <%= c.location || 'Location N/A' %>
                      </div>
                    </div>
                  </div>

                  <div class="crop-right">
                    <div class="price">â‚¹<%= c.price ? Number(c.price).toLocaleString('en-IN') : 'N/A' %>/quintal</div>
                    <div class="qty"><%= c.quantity ? (c.quantity + ' kg available') : 'Qty N/A' %></div>

                    <div class="actions">
                      <form action="/buyer/cart/add" method="POST" style="display:inline">
                        <input type="hidden" name="cropId" value="<%= c._id %>">
                        <button class="btn primary" type="submit"><i class="fas fa-shopping-cart"></i>&nbsp;Buy</button>
                      </form>

                      <form action="/buyer/favorites/toggle" method="POST" style="display:inline">
                        <input type="hidden" name="cropId" value="<%= c._id %>">
                        <button class="btn ghost" type="submit"><i class="fas fa-heart"></i></button>
                      </form>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>
      </section>

      <!-- right: orders & trends -->
      <aside class="right-col">
        <div class="panel">
          <div class="panel-head">
            <div style="display:flex;align-items:center;gap:.6rem">
              <i class="fas fa-shopping-bag" style="color:var(--primary-green)"></i>
              <div style="font-weight:700">Recent Orders</div>
            </div>
            <a href="/buyer/orders" style="color:var(--accent);font-weight:700;text-decoration:none">View All</a>
          </div>

          <div class="panel-body">
            <% if (!recentOrders || recentOrders.length === 0) { %>
              <div style="color:var(--muted)">No recent orders found.</div>
            <% } else { %>
              <% recentOrders.forEach(function(o){ %>
                <div class="order-item">
                  <div class="left" style="background:#fbfff9;border:1px solid #f1f6f1">
                    <i class="fas fa-box" style="color:var(--primary-green)"></i>
                  </div>
                  <div class="order-meta" style="flex:1">
                    <div class="title"><%= (o.crop && o.crop.name) ? o.crop.name : 'Order' %></div>
                    <div class="sub"><%= o.quantity %> kg â€¢ <%= (o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '') %></div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-weight:700;color:var(--primary-green)">â‚¹<%= o.totalPrice ? Number(o.totalPrice).toLocaleString('en-IN') : (o.totalPrice === 0 ? '0' : 'N/A') %></div>
                    <div class="order-date" style="color:var(--muted);font-size:.85rem"><%= o.status || 'placed' %></div>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <div style="display:flex;align-items:center;gap:.6rem">
              <i class="fas fa-chart-line" style="color:var(--primary-green)"></i>
              <div style="font-weight:700">Market Trends</div>
            </div>
            <div style="font-size:.9rem;color:var(--muted)">Realtime</div>
          </div>

          <div class="panel-body">
            <% if (!crops || crops.length === 0) { %>
              <div style="color:var(--muted)">No market trends available.</div>
            <% } else { %>
              <% (crops.slice(0,5)).forEach(function(c){ 
                  const up = (Math.random() > 0.5);
                  const change = (Math.random()*6).toFixed(1);
                  const trendColor = up ? 'var(--success)' : '#e74c3c';
              %>
                <div class="trend-item">
                  <div style="display:flex;gap:.6rem;align-items:center">
                    <div style="width:38px;height:38px;border-radius:8px;background:#fbfff9;display:flex;align-items:center;justify-content:center">ðŸŒ¾</div>
                    <div>
                      <div style="font-weight:700"><%= c.name || 'Crop' %></div>
                      <div style="font-size:.85rem;color:var(--muted)"><%= c.location || '' %></div>
                    </div>
                  </div>

                  <div style="text-align:right;min-width:95px">
                    <div style="font-weight:800;color:var(--success)">â‚¹<%= c.price ? Number(c.price).toLocaleString('en-IN') : 'N/A' %></div>
                    <div style="margin-top:.25rem">
                      <span style="font-size:.8rem;padding:.2rem .5rem;border-radius:6px;color:<%- trendColor %>;background:<%= up ? 'rgba(39,174,96,0.08)' : 'rgba(231,76,60,0.06)' %>">
                        <i class="fas <%= up ? 'fa-arrow-up' : 'fa-arrow-down' %>"></i> <%= change %>%
                      </span>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // simple client interactions (pills, responsive)
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('pill')) {
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        e.target.classList.add('active');
      }
    });

    // mobile: toggle sidebar (if you want to add a button later)
    // small helper: make forms progressive (prevent double submits)
    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', function(){
        const btn = this.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = 0.8;
        }
      });
    });
  </script>
</body>
</html>
